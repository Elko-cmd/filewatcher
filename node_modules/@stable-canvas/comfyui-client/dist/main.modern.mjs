function t(){return t=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var s=arguments[e];for(var n in s)({}).hasOwnProperty.call(s,n)&&(t[n]=s[n])}return t},t.apply(null,arguments)}var e,s,n=(e=function(t){var e=Object.prototype.hasOwnProperty,s="~";function n(){}function i(t,e,s){this.fn=t,this.context=e,this.once=s||!1}function r(t,e,n,r,o){if("function"!=typeof n)throw new TypeError("The listener must be a function");var a=new i(n,r||t,o),c=s?s+e:e;return t._events[c]?t._events[c].fn?t._events[c]=[t._events[c],a]:t._events[c].push(a):(t._events[c]=a,t._eventsCount++),t}function o(t,e){0==--t._eventsCount?t._events=new n:delete t._events[e]}function a(){this._events=new n,this._eventsCount=0}Object.create&&(n.prototype=Object.create(null),(new n).__proto__||(s=!1)),a.prototype.eventNames=function(){var t,n,i=[];if(0===this._eventsCount)return i;for(n in t=this._events)e.call(t,n)&&i.push(s?n.slice(1):n);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(t)):i},a.prototype.listeners=function(t){var e=this._events[s?s+t:t];if(!e)return[];if(e.fn)return[e.fn];for(var n=0,i=e.length,r=new Array(i);n<i;n++)r[n]=e[n].fn;return r},a.prototype.listenerCount=function(t){var e=this._events[s?s+t:t];return e?e.fn?1:e.length:0},a.prototype.emit=function(t,e,n,i,r,o){var a=s?s+t:t;if(!this._events[a])return!1;var c,l,h=this._events[a],u=arguments.length;if(h.fn){switch(h.once&&this.removeListener(t,h.fn,void 0,!0),u){case 1:return h.fn.call(h.context),!0;case 2:return h.fn.call(h.context,e),!0;case 3:return h.fn.call(h.context,e,n),!0;case 4:return h.fn.call(h.context,e,n,i),!0;case 5:return h.fn.call(h.context,e,n,i,r),!0;case 6:return h.fn.call(h.context,e,n,i,r,o),!0}for(l=1,c=new Array(u-1);l<u;l++)c[l-1]=arguments[l];h.fn.apply(h.context,c)}else{var p,d=h.length;for(l=0;l<d;l++)switch(h[l].once&&this.removeListener(t,h[l].fn,void 0,!0),u){case 1:h[l].fn.call(h[l].context);break;case 2:h[l].fn.call(h[l].context,e);break;case 3:h[l].fn.call(h[l].context,e,n);break;case 4:h[l].fn.call(h[l].context,e,n,i);break;default:if(!c)for(p=1,c=new Array(u-1);p<u;p++)c[p-1]=arguments[p];h[l].fn.apply(h[l].context,c)}}return!0},a.prototype.on=function(t,e,s){return r(this,t,e,s,!1)},a.prototype.once=function(t,e,s){return r(this,t,e,s,!0)},a.prototype.removeListener=function(t,e,n,i){var r=s?s+t:t;if(!this._events[r])return this;if(!e)return o(this,r),this;var a=this._events[r];if(a.fn)a.fn!==e||i&&!a.once||n&&a.context!==n||o(this,r);else{for(var c=0,l=[],h=a.length;c<h;c++)(a[c].fn!==e||i&&!a[c].once||n&&a[c].context!==n)&&l.push(a[c]);l.length?this._events[r]=1===l.length?l[0]:l:o(this,r)}return this},a.prototype.removeAllListeners=function(t){var e;return t?this._events[e=s?s+t:t]&&o(this,e):(this._events=new n,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=s,a.EventEmitter=a,t.exports=a},e(s={exports:{}}),s.exports);const i=t=>null==t;class r{static loadImageData(t){const e=new DataView(t).getUint32(0);if(1===e)return new DataView(t).getUint32(0),t.slice(8);throw new Error(`Unknown binary websocket message of type ${e}`)}get registered(){return this.events.eventNames()}constructor(t){var e,s,i,o,a,c,l;if(this.api_host=void 0,this.api_base=void 0,this.clientId=void 0,this.socket=void 0,this.WebSocket=void 0,this.ssl=void 0,this.user=void 0,this.fetch=void 0,this.events=new n,this.socket_callbacks={},this._polling_timer=null,this._polling_interval=1e3,this.closed=!1,this.api_host=null!=(e=t.api_host)?e:r.DEFAULT_API_HOST,this.api_base=null!=(s=t.api_base)?s:r.DEFAULT_API_BASE,this.clientId=null!=(i=t.clientId)?i:"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)}),this.WebSocket=null!=(o=t.WebSocket)?o:globalThis.WebSocket,this.ssl=null!=(a=t.ssl)&&a,this.user=null!=(c=t.user)?c:r.DEFAULT_USER,!globalThis.fetch)throw new Error("fetch is not defined");this.fetch=null!=(l=t.fetch)?l:globalThis.fetch.bind(globalThis),this.WebSocket||console.warn("No WebSocket implementation available, WebSocket disabled")}apiHeaders(e){var s;return t({},this.user?{"Comfy-User":this.user}:{},{Accept:"*/*"},null!=(s=null==e?void 0:e.headers)?s:{})}apiURL(t){const e=new URL(`http${this.ssl?"s":""}://${this.api_host}`);let[s,n]=(this.api_base+t).split("?");return e.pathname=s,e.pathname=e.pathname.replace(/\/+/g,"/"),n&&(e.search=n),this.clientId&&e.searchParams.set("clientId",this.clientId),e.toString()}viewURL(t,e,s){const n=new URLSearchParams({filename:t,subfolder:e,type:s}).toString();return`http${this.ssl?"s":""}://${this.api_host}${this.api_base}/view?${n}`}wsURL(){const t=new URL(`ws${this.ssl?"s":""}://${this.api_host}`);return t.pathname="/ws",this.clientId&&t.searchParams.set("clientId",this.clientId),t.toString()}async fetchApi(e,s){if(this.closed)throw new Error("Client is closed");const n=this.apiURL(e);return this.fetch(n,t({},s,{headers:this.apiHeaders(s)}))}addEventListener(t,e,s){return this.events.on(t,e,s),()=>{this.events.off(t,e)}}on(t,e,s){return this.addEventListener(t,e,s)}startPollingQueue(){var t=this;this._polling_timer||(this._polling_timer=setInterval(async function(){try{const e=await t.fetchApi("/prompt"),s=await e.json();t.events.emit("status",s)}catch(e){t.events.emit("status",null)}},this._polling_interval))}addSocketCallback(t,e,s,n){return this.socket_callbacks[e]=s,t.addEventListener(e,s,n),()=>{delete this.socket_callbacks[e],t.removeEventListener(e,s,n)}}removeSocketCallbacks(){if(this.socket)for(const t in this.socket_callbacks)this.socket.removeEventListener(t,this.socket_callbacks[t]);this.socket_callbacks={}}createSocket(t=!1){if(this.socket)return;if(!this.WebSocket)throw new Error("WebSocket is not defined, please provide a WebSocket implementation");if(this.closed)return;let e=!1;this.socket=new this.WebSocket(this.wsURL()),this.socket.binaryType="arraybuffer",this.addSocketCallback(this.socket,"open",()=>{e=!0,t&&this.events.emit("reconnected")}),this.addSocketCallback(this.socket,"error",()=>{this.socket&&this.socket.close(),t||e||this.startPollingQueue()}),this.addSocketCallback(this.socket,"close",()=>{setTimeout(()=>{this.socket=null,this.createSocket(!0)},300),e&&(this.events.emit("status",null),this.events.emit("reconnecting"))}),this.addSocketCallback(this.socket,"message",t=>{if(this.events.emit("message",t),(t=>"string"!=typeof t.data&&(r.IS_BROWSER?t.data instanceof Blob:!!(ArrayBuffer&&t.data instanceof ArrayBuffer)||!(!Buffer||!Buffer.isBuffer(t.data))))(t)){const e=r.loadImageData(t.data);this.events.emit("image_data",e)}else{const e=JSON.parse(t.data);switch(e.type){case"status":e.data.sid&&(this.clientId=e.data.sid),this.events.emit("status",e.data.status);break;case"progress":this.events.emit("progress",e.data);break;case"executing":this.events.emit("executing",e.data);break;case"executed":this.events.emit("executed",e.data);break;case"execution_start":this.events.emit("execution_start",e.data);break;case"execution_error":this.events.emit("execution_error",e.data);break;case"execution_cached":this.events.emit("execution_cached",e.data);break;case"execution_interrupted":this.events.emit("execution_interrupted",e.data);break;default:this.events.emit(e.type,e.data)}!1===this.registered.includes(e.type)&&this.events.emit("unhandled",e)}})}init(){this.createSocket()}close(){this.closed||(this.closed=!0,this.events.emit("close"),this.disconnect(),this.events.removeAllListeners())}connect({polling:t={enabled:!1},websocket:e={enabled:!0}}={}){var s;return null!=t&&t.enabled&&(this._polling_interval=null!=(s=t.interval)?s:this._polling_interval,this.startPollingQueue()),null!=e&&e.enabled&&this.createSocket(),this}disconnect(){this.socket?this._disconnectSocket():process.nextTick(this._disconnectPolling.bind(this)),this._disconnectPolling()}_disconnectSocket(){const{socket:t}=this;if(t){this.socket=null;try{t.readyState===t.OPEN&&t.close(1e3,"Client closed")}catch(t){}this.removeSocketCallbacks(),"removeAllListeners"in t&&(null==t.removeAllListeners||t.removeAllListeners())}}_disconnectPolling(){null!==this._polling_timer&&(clearInterval(this._polling_timer),this._polling_timer=null)}}r.DEFAULT_API_HOST="127.0.0.1:8188",r.DEFAULT_API_BASE="",r.DEFAULT_USER="",r.IS_BROWSER="undefined"!=typeof window;class o{constructor(){this._cached=void 0,this._cached=globalThis[o.KEY]||new Map,globalThis[o.KEY]=this._cached}clear(){this._cached.clear()}get(t){return this._cached.get(t)}set(t,e){this._cached.set(t,e)}}o.KEY="__COMFY_UI_CLIENT_CACHE__";class a{constructor(t,e){var s,n;this.expire_time_ms=void 0,this.enabled=void 0,this._cached=new o,this.cache_ns="",this.expire_time_ms=null!=(s=null==e?void 0:e.expire_time)?s:a._defaultExpire,this.enabled=null==(n=null==e?void 0:e.enabled)||n,this.cache_ns=t}reset(){this._cached.clear()}_hashArgs(t){try{return JSON.stringify(t)}catch(e){return t.toString()}}warp(t,e){return this.enabled?(...s)=>{const n=Date.now(),i=this._hashArgs(s),r=`${this.cache_ns}:${t}:${i}`,o=this._cached.get(r);if(o&&o.expire>n)return o.result;const a=e(...s);return this._cached.set(r,{result:a,expire:n+this.expire_time_ms}),a}:e}}a._defaultExpire=6e4;class c extends r{constructor(t){super(t),this._cached_fn=void 0,this._plugins=[],this._cached_fn=new a(`${t.api_host}`,t.cache)}use(t){t.install(this),this._plugins.push(t)}async getExtensions(){var t=this;return this._cached_fn.warp("extensions",async function(){const e=await t.fetchApi("/extensions",{cache:"no-store"});return await e.json()})()}async getEmbeddings(){var t=this;return this._cached_fn.warp("embeddings",async function(){const e=await t.fetchApi("/embeddings",{cache:"no-store"});return await e.json()})()}async getNodeDefs(){var t=this;return this._cached_fn.warp("object_info",async function(){const e=await t.fetchApi("/object_info",{cache:"no-store"});return await e.json()})()}resetCache(){this._cached_fn.reset()}async queuePrompt(t,{prompt:e,workflow:s}){const n={client_id:this.clientId,prompt:e,extra_data:{extra_pnginfo:{workflow:s}}};-1===t?n.front=!0:0!==t&&(n.number=t);const i=await this.fetchApi("/prompt",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(200!==i.status){const t=await i.text();try{throw{response:JSON.parse(t)}}catch(e){throw{response:t}}}return await i.json()}async getItems(t){return"queue"===t?this.getQueue():this.getHistory()}async getQueue(){try{const t=await this.fetchApi("/queue"),e=await t.json();return{Running:e.queue_running.map(t=>({prompt:t,remove:{name:"Cancel",cb:()=>this.interrupt()}})),Pending:e.queue_pending.map(t=>({prompt:t}))}}catch(t){return console.error(t),{Running:[],Pending:[]}}}async getHistory(t=200){try{const e=await this.fetchApi(`/history?max_items=${t}`);return{History:Object.values(await e.json())}}catch(t){return console.error(t),{History:[]}}}async getSystemStats(){return(await this.fetchApi("/system_stats")).json()}async postApi(t,e){await this.fetchApi("/"+t,{method:"POST",headers:{"Content-Type":"application/json"},body:e?JSON.stringify(e):void 0})}async deleteItem(t,e){await this.postApi(t,{delete:[e]})}async clearItems(t){await this.postApi(t,{clear:!0})}async interrupt(){await this.postApi("interrupt",null)}async free(t){await this.postApi("free",t)}async getUserConfig(){return(await this.fetchApi("/users")).json()}async createUser(t){return this.fetchApi("/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t})})}async getSettings(){return(await this.fetchApi("/settings")).json()}async getSetting(t){return(await this.fetchApi(`/settings/${encodeURIComponent(t)}`)).json()}async storeSettings(t){return this.fetchApi("/settings",{method:"POST",body:JSON.stringify(t)})}async storeSetting(t,e){return this.fetchApi(`/settings/${encodeURIComponent(t)}`,{method:"POST",body:JSON.stringify(e)})}async getUserData(t,e){return this.fetchApi(`/userdata/${encodeURIComponent(t)}`,e)}async storeUserData(e,s,n){const i=await this.fetchApi(`/userdata/${encodeURIComponent(e)}`,t({method:"POST",body:null!=n&&n.stringify?JSON.stringify(s):s},n));if(200!==i.status){const t=await i.text();throw new Error(`Error storing user data file '${e}': ${i.status} ${t}`)}}async getSamplers(){var t;const e=(await this.getNodeDefs()).KSampler;return(null==e||null==(t=e.input)||null==(t=t.required)||null==(t=t.sampler_name)?void 0:t[0])||[]}async getSchedulers(){var t;const e=(await this.getNodeDefs()).KSampler;return(null==e||null==(t=e.input)||null==(t=t.required)||null==(t=t.scheduler)?void 0:t[0])||[]}async getSDModels(){var t;const e=(await this.getNodeDefs()).CheckpointLoaderSimple;return(null==e||null==(t=e.input)||null==(t=t.required)||null==(t=t.ckpt_name)?void 0:t[0])||[]}async getCNetModels(){var t;const e=(await this.getNodeDefs()).ControlNetLoader;return(null==e||null==(t=e.input)||null==(t=t.required)||null==(t=t.control_net_name)?void 0:t[0])||[]}async getUpscaleModels(){var t;const e=(await this.getNodeDefs()).UpscaleModelLoader;return(null==e||null==(t=e.input)||null==(t=t.required)||null==(t=t.model_name)?void 0:t[0])||[]}async getHyperNetworks(){var t;const e=(await this.getNodeDefs()).HypernetworkLoader;return(null==e||null==(t=e.input)||null==(t=t.required)||null==(t=t.hypernetwork_name)?void 0:t[0])||[]}async getLoRAs(){var t;const e=(await this.getNodeDefs()).LoraLoader;return(null==e||null==(t=e.input)||null==(t=t.required)||null==(t=t.lora_name)?void 0:t[0])||[]}async getVAEs(){var t;const e=(await this.getNodeDefs()).VAELoader;return(null==e||null==(t=e.input)||null==(t=t.required)||null==(t=t.vae_name)?void 0:t[0])||[]}async getPromptStatus(t){const{Running:e,Pending:s}=await this.getQueue(),n=e.some(e=>{var s;return(null==e||null==(s=e.prompt)?void 0:s[1])===t}),i=s.some(e=>{var s;return(null==e||null==(s=e.prompt)?void 0:s[1])===t});return{running:n,pending:i,done:!n&&!i}}async getPromptOutputs(t){const{History:e}=await this.getHistory(),s=e.find(e=>e.prompt[1]===t);if(!s)throw new Error(`Prompt [${t}] not found in history`);const n=s.status.status_str;if("success"!==n)throw new Error(`Prompt [${t}] failed with status: ${n}`);return s.outputs}async getPromptImageResult(t){const e=await this.getPromptOutputs(t);return{images:Object.values(e).flatMap(t=>t.images||[]).map(t=>{const{filename:e,subfolder:s,type:n}=t;return i(e)||i(s)||"output"!==n?null:this.viewURL(e,s,n)}).filter(Boolean).map(t=>({type:"url",data:t})),prompt_id:t}}async waitForPrompt(t,e=1e3){let s=await this.getPromptStatus(t);for(;!s.done;)await new Promise(t=>setTimeout(t,e)),s=await this.getPromptStatus(t)}async waitForPromptWebSocket(t){const e={images:[],prompt_id:t};return new Promise((s,n)=>{const r=this.on("image_data",t=>{e.images.push({type:"buff",data:t})}),o=this.on("executed",n=>{const{prompt_id:a,output:c}=n;if(a!==t)return;const{images:l=[]}=c||{};for(const t of l){const{filename:s,subfolder:n,type:r}=t||{};i(s)||i(n)||"output"!==r||e.images.push({type:"url",data:this.viewURL(s,n,r)})}s(e),o(),r()})})}randomizePrompt(t){for(const e of Object.values(t))"KSampler"===e.class_type&&(e.inputs.seed=Math.floor(Math.random()*(2**32-1)))}async _enqueue_prompt(t,e){null!=e&&e.disable_random_seed||this.randomizePrompt(t);const s=await this.queuePrompt(0,{prompt:t,workflow:null==e?void 0:e.workflow});if("error"in s)throw new Error(s.error);return s}async runPrompt(t,e){const s=(await this._enqueue_prompt(t,e)).prompt_id;return await this.waitForPrompt(s,null==e?void 0:e.polling_ms),await this.getPromptImageResult(s)}async enqueue_polling(t,e){const s=(await this._enqueue_prompt(t,e)).prompt_id;return await this.waitForPrompt(s,null==e?void 0:e.polling_ms),await this.getPromptImageResult(s)}async enqueue(e,s){const n=(await this._enqueue_prompt(e,s)).prompt_id;let i;null!=s&&s.progress&&(i=this.on("progress",e=>{const i=t({},"progress"in e?t({},e.progress):{},e);i.prompt_id===n&&(null==s||null==s.progress||s.progress(i))}));try{return await this.waitForPromptWebSocket(n)}finally{null==i||i()}}}class l{constructor(t,e){this.workflow=void 0,this.client=void 0,this._task_id=void 0,this._enqueue_req=void 0,this._result={images:[],prompt_id:""},this.executed=!1,this.workflow=t,this.client=e}enqueue(){const{prompt:t,workflow:e}=this.workflow;this._enqueue_req=this.client._enqueue_prompt(t,{workflow:e}),this._task_id=this._enqueue_req.then(t=>t.prompt_id),this._enqueue_req.then(t=>{this._result.prompt_id=t.prompt_id})}load_result_data(t){const{output:e}=t,{images:s=[]}=e||{};for(const t of s){const{filename:e,subfolder:s,type:n}=t||{};i(e)||i(s)||"output"!==n||this._result.images.push({type:"url",data:this.client.viewURL(e,s,n)})}}async query(){if(!this._task_id)throw new Error("This workflow is not enqueued and the execution status cannot be queried");return this.client.getPromptStatus(await this._task_id)}async interrupt(){if(!this._task_id)throw new Error("This workflow is not enqueued and the execution status cannot be interrupt");const t=await this._task_id,{pending:e,running:s,done:n}=await this.query();if(!n){if(!e){if(s)return this.client.interrupt();throw new Error(`wrong task status, id: ${t}`)}this.client.deleteItem("queue",t)}}async wait(){if(!this._task_id)throw new Error("This workflow is not enqueued and the execution status cannot be wait");const t=await this._task_id;return new Promise((e,s)=>{(t=>{let e=[];e=t(()=>e.forEach(t=>t()))})(n=>[this.client.on("execution_interrupted",e=>{e.prompt_id===t&&(s(new Error("Execution Interrupted")),n())}),this.client.on("image_data",t=>{this.executed||this._result.images.push({type:"buff",data:t})}),this.client.on("executed",s=>{s.prompt_id===t&&(this.load_result_data(s),this.executed=!0,e(this._result),n())})])})}}const h=globalThis.structuredClone?globalThis.structuredClone:t=>JSON.parse(JSON.stringify(t));class u{constructor(){this._workflow={prompt:{}},this._last_node_id=0,this.classes=this._createClassesProxy()}_createClassesProxy(){return new Proxy({},{get:(t,e,s)=>e in t?t[e]:t=>{const s={class_type:e.toString(),inputs:t},n=(++this._last_node_id).toString();return this._workflow.prompt[n]=s,Array.from({length:10},(t,e)=>[n,e])}})}reset(){this._workflow.prompt={},this._workflow.workflow=void 0,this._last_node_id=0}end(){return this.workflow()}workflow(){return h(this._workflow)}invoke(t){const e=this.instance(t);return e.enqueue(),e.wait()}instance(t){const{prompt:e,workflow:s}=this.workflow();return new l({prompt:e,workflow:s},t)}invoke_polling(t){const{prompt:e,workflow:s}=this.workflow();return t.enqueue_polling(e,{workflow:s})}}class p{constructor(){this.hooks=[]}install(t){for(const e of this.hooks){const s=t,n=s[e.name].bind(t);s[e.name]=(...s)=>e.fn.bind(t)(n,...s)}}addHook(t){this.hooks.push(t)}}class d extends p{constructor(t){super(),this.options=void 0,this.options=t,this.addHook({type:"function",name:"apiURL",fn:(t,...e)=>{const s=t(...e),n=new URL(s);return n.searchParams.set("token",this.options.token),n.toString()}}),this.addHook({type:"function",name:"wsURL",fn:(t,...e)=>{const s=t(...e),n=new URL(s);return n.searchParams.set("token",this.options.token),n.toString()}})}}export{p as ClientPlugin,c as ComfyUIApiClient,u as ComfyUIWorkflow,r as ComfyUIWsClient,d as LoginAuthPlugin};
//# sourceMappingURL=main.modern.mjs.map
